# WeatherApp

## Weiyi Liu and Weihang Wu
## Introduction
This project is a ShinyApp for weather data visualizing and comparison. The link of this ShinyApp is [here](https://wwhworks.shinyapps.io/WeatherExplore/). Introduction of the usage and the reference of background API (OpenWeather API) is shown on the **Guide** page.

The basic logic of this App is that, we firstly fetch the data satisfying the user's requirements from the API, then generate visualization plots from the fetched data. The visualization contains two parts: The first part **View on Map** provides some visualizations on geographical dimension, and the second part **View by Time** provides some visualizations on time dimension. In the second part, we also provide an automatic temperature forecast by SARIMA time series model.


## View on Map
### Data
We call data from "Current and forecast weather data" function in "[One Call API](https://openweathermap.org/api/one-call-api)". This API can return the hourly weather data of a target location from current hour to (at most) 48 hours later.

### Method
#### Preparation of Geographical Data (geo_data.R)
+ `state_bound.RData` and `county.RData`: These two files come from package `USAboundaries`. This package provide geographical sf data for the boundaries of all US states and counties. These datasets will help us on future data cleaning and visualization. ShinyApp publishing cannot recognize this package for some unknown reason, so we saved these two datasets as RData files and load them directly in our App.

+ `available_loc2.RData`: This dataset includes all US cities available in the API, as well as their location coordinates. The original dateset was a json file provided by the API [website](http://bulk.openweathermap.org/sample/). We did some preprocessing and cleaning (match the cites with states), and saved it as RData file. Our API will load the RData file directly to save time.

+ `get_locations`: This function will return all available cities (and their coordinates) in a given state.

+ `get_counties`: This function will return all counties (and their boundary coordinates) in a given state.

+ `get_location_one`: This function will return the location data for a given state name and city name.

#### Data Fetching Functions (data_fetch.R)
+ `get_map_data`: This function compiles the url of the call, and fetch 48-hours data for ONE location from the API.

+ `get_state_data`: This function will fetch and clean 48-hours data for all available cities in a given state by applying `get_locations` and `get_map_data`.

+ `plt_data`: In visualization part, we need to compute counties' average weather indicators from all cities in the county. Therefore, we need to identify which county the city is in for each city. This function achieves that and returns a final dataset available for visualization.

#### Visualization Functions (visualization.R)
+ `map_plot`: This function returns four map visualization plots of weather data. Detail usage can be seen in user guide in App.


## View by Time
### Data
We call data from "Current and forecast weather data" as well as "Historical weather data" function in "[One Call API](https://openweathermap.org/api/one-call-api)". The API can return (at most) 48-hours forecast data, as well as hourly weather records in past (at most) 5 days.

### Method
#### Data Fetching Functions (data_fetch.R)
+ `get_loc_data`: This function compiles the url for both the forecast call and the historical call, and fetch all data in past 5 days and future 2 days. The historical weather can only be call for one location and one day, so we will consume 5 calls for historical data fetching. Note that this function is designed to call for ONE location.

+ `get_3loc_data`: This function helps to call forecasting and historical data for at most 3 locations. The inputs of this function are lists containing the state, the name, and the coordinates of the cities. Such a list can be generated by `get_location_one` function. 

#### Visualization Functions (visualization.R)
+ `weath_grid_plot`: This function generates the first plot in our output board. An example is shown in user guide.

+ `temp_ts_plot`: This function generates the second plot in our output board. An example is shown in user guide.

+ `temp_circ_plot`: This function generates the third plot in our output board. An example is shown in user guide.

+ `humid_ts_plot`: This function generates the forth plot in our output board. An example is shown in user guide.

The API only have 2-day weather forecast. We are also interested in a more "aggressive" forecast in a longer time span, so we apply a **SARIMA model** to forecast the hourly temperature in the third day in the future, based on the 5-day historical data and the 2-day meteorology forecasting data. Temperature has a strong seasonal effect in a day, so it is easier to be fitted by a time series model than other variables. SARIMA is very suitable for this seasonal feature.

We do not implement model selection (hyperparameter selection of p, d, q, P, D, Q) here for SARIMA model, because it is time consuming and will draw down the speed of our App. Instead, we use SARIMA(3,1,1)(1,1,0)[24] (SARIMA(p,d,q)(P,D,Q)[s]) for fixed. s=24 is based on the natural season of one day. d=1 and D=1 are determined based on our trials of differentiation. p, q, P, Q are roughly determined based on our trials of looking ACF and PACF plots.

+ `sarima_one_loc` fit the SARIMA model for a given series of temperature (for ONE location), and generate plots of forecasts. Examples can be found in the user guide page, the dark purple region represents the 80% confidence interval and the light purple region represents the 95% confidence interval.

+ `sarima_plot` returns plots for all locations in the data returned by `get_3loc_data`, by applying `sarima_one_loc` repeately.



## Some Cautions
1. A free API key of OpenWeather API can only make 1000 calls per day and 60 calls per minute. The former suggests that the user should be careful to call large states such as California and New York in "View on Map", since we need one call for each city, and these states contain hundreds of cities which will consume hundreds of calls. The latter suggests us to use a space out for one-second to avoiding http error, and this makes calling large states also be time consuming. (A subscription for an extra-charge account will solve this problem.)

2. To unify the time for all locations, we use UTC time in our App. 



## Referneces

+ Weather API: [https://openweathermap.org/price/](https://openweathermap.org/price/) 

+ Shiny Tutorial: [https://shiny.rstudio.com/](https://shiny.rstudio.com/)
